---
import PageLayout from "@/layouts/PageLayout.astro";
import { ListViewer } from "@/components/list/ListViewer";
import * as Download from "@/components/download";

// Disable prerendering to allow server-side rendering of dynamic routes
export const prerender = false;

const { userId } = Astro.params;

// Extract cityId from URL query parameters for city-specific favorites
const cityId = Astro.url.searchParams.get("cityId") || undefined;

// API base URL - defaults to localhost in dev, production URL otherwise
const API_BASE_URL =
  import.meta.env.PUBLIC_API_BASE_URL || "http://localhost:3000";

if (!userId) {
  return Astro.redirect("/");
}

const deepLink = cityId
  ? `resx://list/${userId}?cityId=${cityId}`
  : `resx://list/${userId}`;
---

<PageLayout
  title={`Favorites | ResX`}
  description="View curated favorite restaurants shared by the ResX community"
>
  <!-- Attempt to open deep link on mobile devices -->
  <script is:inline define:vars={{ deepLink }}>
    // Only attempt deep link on mobile
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    if (isMobile) {
      // Try to open the app via deep link
      // If app is not installed, this will fail silently and page will render normally
      const startTime = Date.now();
      window.location.href = deepLink;

      // Stop trying after 1 second - if we're still here, app isn't installed
      setTimeout(() => {
        const elapsed = Date.now() - startTime;
        // If document is still visible and timeout elapsed, app isn't installed
        // Stop trying and let the web view display
        if (document.visibilityState === "visible" && elapsed < 1500) {
          // Do nothing, page will render
        }
      }, 1000);
    }
  </script>

  <!-- Hide navbar and footer on mobile for this page -->
  <style>
    @media (max-width: 768px) {
      nav,
      footer {
        display: none !important;
      }
    }
  </style>
  <!-- Section 1: Title/Subtitle with gradient background (hidden on mobile) -->
  <div
    class="from-sand-storm/20 relative hidden overflow-hidden bg-linear-to-tl md:block"
  >
    <div
      id="title-container"
      class="relative z-10 pt-48 pb-16 text-center opacity-0"
    >
      <h1
        id="title-heading"
        class="inline-block text-[56px] leading-[1.2] font-medium tracking-[-0.5px] text-white"
      >
        <span id="user-name"></span>'s Favorites
      </h1>
      <p
        id="restaurant-subtitle"
        class="mt-6 text-2xl tracking-[-0.5px] text-white/50"
      >
        <span id="restaurant-count"></span>
      </p>
    </div>
  </div>

  <!-- Divider 1 (hidden on mobile) -->
  <div
    id="divider-1"
    class="relative hidden h-px bg-linear-to-r from-transparent via-white/10 to-transparent md:block"
  >
  </div>

  <!-- Section 2: Restaurant List with darker background -->
  <div class="relative bg-[#191919]">
    <!-- Radial gradient overlay -->
    <div
      class="absolute inset-0 opacity-40"
      style="background: radial-gradient(ellipse 50% 35% at 50% 50%, rgba(255, 217, 161, 0.5) 0%, rgba(255, 217, 161, 0.1) 100%);"
    >
    </div>
    <div class="relative z-10">
      <ListViewer
        client:load
        userId={userId}
        cityId={cityId}
        apiBaseUrl={API_BASE_URL}
      />
    </div>
  </div>

  <!-- Divider 2 (hidden on mobile) -->
  <div
    class="relative hidden h-px bg-linear-to-r from-transparent via-white/10 to-transparent md:block"
  >
  </div>

  <!-- Section 3: Footer with Download QR Code (hidden on mobile) -->
  <div
    class="from-sand-storm/20 relative hidden bg-linear-to-tl px-4 py-16 md:block"
  >
    <div
      class="mx-auto grid max-w-[1240px] grid-cols-1 items-center gap-12 lg:grid-cols-2"
    >
      <!-- Left: QR Code Section -->
      <div class="flex flex-col items-center lg:items-start">
        <div class="flex items-center gap-6">
          <div
            class="before:bg-bronze bg-coal z-10 rounded-xl border border-white/10 bg-black p-2 shadow-lg"
          >
            <img
              src="https://api.qrserver.com/v1/create-qr-code/?size=144x144&data=https://qrco.de/bgPQTJ"
              alt="Download ResX App QR Code"
              class="h-36 w-36"
            />
          </div>
          <div class="space-y-1">
            <p class="text-lg font-medium text-white">Download the ResX app</p>
            <p class="text-sm text-white/50">
              Scan the QR code to download for your device
            </p>
          </div>
        </div>
      </div>

      <!-- Right: Description Text -->
      <div class="flex items-center justify-center lg:justify-end">
        <p
          class="max-w-[422px] text-center text-base leading-[1.4] text-white/50 lg:text-right"
        >
          Continue browsing the best restaurants, claim the city's top
          reservations, or submit reservations and save on cancelation fees with
          the ResX app.
        </p>
      </div>
    </div>
  </div>
</PageLayout>
